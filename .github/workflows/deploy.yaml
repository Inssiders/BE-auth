name: Deploy to EC2 with Docker Compose

on:
  workflow_run:
    workflows: [ "Publish Docker image on Semver tag push" ]
    types:
      - completed

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4.1.0
        with:
          aws-region: ap-northeast-2
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          retry-max-attempts: 3

      - name: Open SSH port for GitHub Actions
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.AWS_SECURITY_GROUP_ID }} \
            --protocol tcp --port 22 --cidr 0.0.0.0/0 || true

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.AWS_INSTANCE_HOST }}
          port: ${{ secrets.AWS_SSH_PORT }}
          username: ubuntu
          key: ${{ secrets.AWS_SSH_PK }}
          script: |
            echo "üöÄ EC2Ïóê Î∞∞Ìè¨ ÏãúÏûë"
            
            # 1. Î†àÌè¨ÏßÄÌÜ†Î¶¨ pull
            cd BE-main
            git pull origin main
            
            RAW_TAG="${{ github.event.workflow_run.head_branch }}"
            IMAGE_TAG="${RAW_TAG#v}"
            echo "üì¶ Ï†ÑÎã¨Î∞õÏùÄ Git ÌÉúÍ∑∏: $RAW_TAG ‚Üí Ïù¥ÎØ∏ÏßÄ ÌÉúÍ∑∏: $IMAGE_TAG"
            
            # 2. .env.prod Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏúºÎ©¥ ÏóêÎü¨
            if [ ! -f .env.prod ]; then
              echo "‚ùå .env.prod ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§. ÏàòÎèôÏúºÎ°ú ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî."
              exit 1
            fi
            
            echo "üìù .env.prod IMAGE_TAG ÏóÖÎç∞Ïù¥Ìä∏"
            # Í∏∞Ï°¥ IMAGE_TAG ÎùºÏù∏Ïù¥ ÏûàÏúºÎ©¥ ÎçÆÏñ¥Ïì∞Í∏∞, ÏóÜÏúºÎ©¥ Ï∂îÍ∞Ä
            grep -q '^IMAGE_TAG=' .env.prod && \
              sed -i "s/^IMAGE_TAG=.*/IMAGE_TAG=$IMAGE_TAG/" .env.prod || \
              echo "IMAGE_TAG=$IMAGE_TAG" >> .env.prod

            # 3. Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ
            chmod +x scripts/run-docker-prod.sh
            ./scripts/run-docker-prod.sh

      - name: Close SSH port after deploy
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.AWS_SECURITY_GROUP_ID }} \
            --protocol tcp --port 22 --cidr 0.0.0.0/0 || true
